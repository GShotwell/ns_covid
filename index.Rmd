---
title: "NS Covid Rates"
author: "Gordon Shotwell"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: html_document
params:
  data: covid
---

```{r setup, include=FALSE}
library(dplyr)
library(ggplot2)
library(RcppRoll)
library(readr)

raw_data  <-  readr::read_csv("https://novascotia.ca/coronavirus/data/ns-covid19-data.csv", skip = 1)

process_covid <- function(raw_data) {
  raw_data$Hospitalized <- NULL
  covid <- raw_data[, 1:8]
  names(covid) <- tolower(names(covid))
  names(covid)[1:2] <- c("date", "new_cases")
  covid$positives <- cumsum(covid$new_cases)
  write.csv(covid, "ns_daily_covid.csv")
  return(covid)
}

covid <- process_covid(raw_data)
covid <- covid %>% 
  mutate(total_deaths = cumsum(deaths)) %>% 
  mutate(active = positives - resolved - total_deaths) %>% 
  mutate(wave = ifelse(date < "2020-10-21", "Wave 1", "Wave 2")) %>% 
  arrange(date)

active_cases <- covid$active[nrow(covid)]

```
# Data 

There are **`r active_cases`** active cases in Nova Scotia on `r max(covid$date)`.

The data comes from [daily reports](https://novascotia.ca/coronavirus/#cases) from the Nova Scotia Government which I record in a [Github Repo](https://github.com/GShotwell/ns_covid).

```{r plots, echo = FALSE, warning=FALSE, message=FALSE}
theme_set(theme_minimal())
```


```{r, echo = FALSE, warning=FALSE, message=FALSE}

covid %>% 
  group_by(wave) %>% 
  mutate(date_num = date - min(date)) %>%
  ggplot(aes(x = date_num, y = active, group = wave, colour = wave)) +
  geom_line() +
    labs(y = "Active Cases",
       x = "Days since outbreak began",
       title = "Nova Scotia Covid Waves",
       subtitle = "Wave 2 began on October 21") +
  theme_light()

covid %>% 
  group_by(wave) %>% 
  mutate(date_num = date - min(date)) %>%
  mutate(roll_cases = roll_mean(new_cases, 7, fill = NA, align = "right")) %>% 
  ggplot(aes(x = date_num, y = roll_cases, group = wave, colour = wave)) +
  geom_line() +
    labs(y = "New cases (7 day average)",
       x = "Days since outbreak began",
       title = "Nova Scotia Covid Waves",
       subtitle = "Wave 2 began on October 21") +
  theme_light()

```
