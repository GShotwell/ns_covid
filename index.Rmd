---
title: "NS Covid Rates"
author: "Gordon Shotwell"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: html_document
params:
  data: covid
---

```{r setup, include=FALSE}
library(tidyverse)
library(RcppRoll)
library(plotly)
covid <- readRDS("covid.Rds")
covid <- covid %>% 
  mutate(total_tests = positives + negatives,
         daily_pos = positives - lag(positives),
         daily_neg = negatives - lag(negatives),
         daily_tests = daily_pos + daily_neg,
         date = lubridate::ymd(date),
         five_day_cases = roll_sum(daily_pos, 5, fill = NA, align = "right"),
         total_deaths = cumsum(deaths))
```
# Data 

The data comes from [daily reports](https://novascotia.ca/coronavirus/#cases) from the Nova Scotia Government which I record in a [Github Repo](https://github.com/GShotwell/ns_covid).

```{r plots, echo = FALSE, warning=FALSE, message=FALSE}
theme_set(theme_minimal())

p <- covid %>% 
  select(date, total = positives, central, western, northern, eastern, central) %>% 
  pivot_longer(-date, names_to = "Region", values_to = "cases") %>% 
  mutate(Region = factor(Region, 
                         levels = c("total", "central", "western", "eastern", "northern"),
                         labels = c("All cases", "Central", "Western", "Eastern", "Northern"))) %>% 
  ggplot(aes(x  = date, y = cases, group = Region, colour = Region)) +
  geom_line() +
  labs(y = "Positive Tests",
       x = "Date",
       title = "Nova Scotia COVID Cases") 
ggplotly(p)

```

It's also useful to track active cases which are all cases which haven't recovered yet.

```{r, echo = FALSE, warning=FALSE, message=FALSE}
p <-  covid %>% 
  mutate(in_hospital = icu + `non-icu`) %>% 
  select(date, 
         total = positives, 
         recovered, 
         in_hospital,
         deaths = total_deaths) %>% 
  mutate(active = total - recovered - deaths) %>% 
  pivot_longer(-date, names_to = "group", values_to = "number") %>% 
  mutate(group = factor(group, levels = c("total", 
                                          "active",  
                                          "recovered", 
                                          "in_hospital",
                                          "deaths"),
                        labels = c("Total", "Active",  "Recovered", "Hospital", "Deaths"))) %>% 
  ggplot(aes(x = date, y = number, group = group, colour = group)) +
  geom_line() +
  labs(y = "Number of people",
       x = "Date",
       title = "Nova Scotia Covid Cases")
ggplotly(p)
```




I stole this plot from an excellent [data visualization](https://aatishb.com/covidtrends/) of covid trends. Each point is a day and it shows the sum of new cases in the previous five days against the number of total cases. I chose a five day sum because that's about the mean incubation period for COVID-19. 

```{r, echo = FALSE, warning=FALSE, message=FALSE}
p <- ggplot(covid, aes(x = positives, y = five_day_cases)) +
  geom_point() +
  geom_smooth(se = FALSE, size = 0.5, alpha = 0.1) +
  geom_vline(xintercept = 41, 
             colour = "gray") +
  annotate("text", 
           x = 37, 
           y = 60, 
           label = "State of Emergency", 
           color = "gray",
           angle = 90) +
  labs(y = "Cases in previous five days",
       x = "Total cases",
       title = "Nova Scotia COVID cases")
ggplotly(p)
```

## Tests

Next we look at tests. The first one shows how great the microbiology lab has been in ramping up testing capacity. This is [incredible](https://www.cbc.ca/news/canada/nova-scotia/covid-19-microbiology-lab-testing-health-care-1.5515115) and they deserve a great deal of thanks from all of us. I would be sending gift baskets of home made saurkraut and miso if that didn't violate social distancing rules.

```{r, echo = FALSE, warning=FALSE, message=FALSE}
p <- ggplot(covid, aes(x  = date, y = daily_tests)) +
  geom_point() +
  geom_line() +
  labs(y = "Test per day",
       x = "Date",
       title = "Nova Scotia COVID Tests") 
ggplotly(p)
```

The last thing to look at is the positive rate for our testing. This should be read in conjunction with the previous chart because if we test a lot of people, the positive rate will probably go down even though nothing changed about the disease.

```{r, echo = FALSE, warning=FALSE, message=FALSE}
p <- covid %>% 
  mutate(positive_rate = daily_pos / daily_tests) %>% 
  ggplot(aes(x  = date, 
                  y = positive_rate,
                  size = daily_tests)) +
  geom_point() +
  scale_y_continuous(labels = scales::percent)+
  labs(y = "Positive rate",
       x = "Date",
       title = "Nova Scotia COVID tests") 
ggplotly(p)
```


# Raw data

Here is the raw data I collect, please let me know if I've made any mistakes in recording this data. 

```{r, echo = FALSE, warning=FALSE, message=FALSE}
covid %>% 
  arrange(desc(date)) %>% 
  DT::datatable(rownames = FALSE) 
```


