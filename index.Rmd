---
title: "NS Covid Rates"
author: "Gordon Shotwell"
output: html_document
params:
  data: covid
---

```{r setup, include=FALSE}
library(dplyr)
library(ggplot2)
library(RcppRoll)
library(lubridate)
library(readr)
library(httr)
library(tidyr)
resp <- GET("https://api.covid19tracker.ca/reports/province/ns")
covid <- tibble(raw = content(resp)$data) %>% 
  unnest_auto(raw)

covid <- covid %>% 
  mutate(active = total_cases - total_fatalities - total_recoveries,
         date = lubridate::ymd(date)) %>%
  filter(date > "2020-03-15") %>% 
  mutate(wave = ifelse(date < "2020-10-21", "Wave 1", "Wave 2")) %>% 
  arrange(date) %>% 
  group_by(wave) %>% 
  mutate(date_num = as.numeric(date - min(date))) %>% 
  mutate(active = ifelse(active < 0, 0, active)) 

active_cases <- covid$active[nrow(covid)]
```

There are **`r active_cases`** active cases in Nova Scotia as of **`r max(covid$date[covid$change_tests > 0])`**.

The data comes from [the Covid Tracker API](https://api.covid19tracker.ca/). 

```{r plots, echo = FALSE, warning=FALSE, message=FALSE}
theme_set(theme_minimal())
```

# Cases

```{r, echo = FALSE, warning=FALSE, message=FALSE}
covid %>% 
  ggplot(aes(x = date_num, y = active, group = wave, colour = wave)) +
  geom_step() +
  labs(y = "Active Cases",
       x = "Days since outbreak began",
       title = "Nova Scotia's second wave has been smaller than the first",
       subtitle = "Wave 2 began on October 21") +
  theme_light()

covid <- covid %>% 
  arrange(date) %>% 
  mutate(change_cases = ifelse(is.na(change_cases), 0, change_cases)) %>% 
  mutate(roll_cases = roll_mean(change_cases, 7, fill = NA, align = "right")) %>%
  mutate(eight_day = roll_sum(change_cases, 8, fill = NA, align = "right")) 

labs <- covid %>% 
  group_by(wave) %>% 
  summarise(max = max(roll_cases, na.rm = TRUE))

ggplot(covid, aes(x = date_num, y = roll_cases, group = wave, colour = wave)) +
  geom_line() +
  geom_point(aes(y = change_cases), alpha = 0.2) +
  scale_y_continuous(breaks = round(c(covid$roll_cases[nrow(covid)], labs$max), 1)) +
  labs(y = "New cases (7 day average)",
       x = "Days since outbreak began",
       title = "Nova Scotia's second wave has been smaller than the first",
       subtitle = "Wave 2 began on October 21") +
  theme(panel.grid.minor = element_blank())
```

# Vaccines

```{r message=FALSE, warning=FALSE, echo=FALSE}
vaccines <- covid %>% 
  arrange(desc(date)) %>% 
  select(date, change_vaccinations, change_vaccines_distributed, 
         total_vaccinations, total_vaccines_distributed, total_vaccinated, active) %>% 
  mutate(full_doses = 2 * total_vaccinated,
         reserved = total_vaccinations - full_doses,
         unused = total_vaccines_distributed - total_vaccinations - reserved)

vaccines <- vaccines %>% 
  filter(date > lubridate::ymd("2020-12-01")) %>% 
  mutate(date = lubridate::ymd(date)) %>% 
  mutate(in_freezer = total_vaccines_distributed - total_vaccinations) %>% 
  arrange(date)

plot_df <- vaccines %>% 
  mutate(vaccine_ratio = total_vaccinated / active) %>% 
  filter(!is.na(vaccine_ratio)) 
```


Nova Scotia has had a very slow vaccine rollout, even accounting for the policy of reserving second doses, the amount of unused vaccine is high. 


```{r message=FALSE, warning=FALSE, echo=FALSE}
plot_df %>%
  ungroup() %>% 
  mutate(Reserved = reserved + total_vaccinations) %>% 
  select(date,  `Available` = total_vaccines_distributed, 
         Reserved,
        `Distributed` = total_vaccinations) %>% 
  pivot_longer(-date) %>% 
  mutate(name = factor(name, levels = c("Available", "Reserved", "Distributed"))) %>% 
  filter(date > "2020-12-21") %>% 
  ggplot(aes(x = date, y = value, group = name, fill = name)) +
  geom_ribbon(aes(ymax = value, ymin = 0)) +
  labs(
    title = "Nova Scotia's vaccine distribution has been slow",
    x = "Date",
    y = "Doses",
    fill = "Doses"
  ) +
  scale_fill_viridis_d(option = "D") +
  scale_y_continuous(breaks = c(max(plot_df$total_vaccinations), 
                                max(plot_df$total_vaccines_distributed, na.rm = TRUE)),
                     labels = scales::comma) +
  theme(panel.grid.minor = element_blank())
```


```{r message=FALSE, warning=FALSE, echo=FALSE}
vaccines %>% 
  ungroup() %>% 
  filter(date > "2021-01-12") %>% 
  select(date, `Sitting in the freezer` = unused, `Reserved for second dose` = reserved) %>% 
  pivot_longer(-date, names_to = "Type", values_to = "value") %>% 
  ggplot(aes(x = date, y = value, group = Type, colour = Type)) +
  geom_path() +
  scale_y_continuous(breaks = c(vaccines$unused[nrow(vaccines)], vaccines$reserved[nrow(vaccines)]),
                     labels = scales::comma) +
  labs(title = "Nova Scotia has a lot of unused vaccine",
       y = "Doses",
       x = "Date") +
  theme(panel.grid.minor = element_blank()) 
```

```{r message=FALSE, warning=FALSE, echo=FALSE}
plot_df2 <- vaccines %>% 
  filter(date > "2021-01-17") %>% 
  mutate(week_day = lubridate::wday(date, label = TRUE)) %>% 
  group_by(week_day) %>% 
  summarize(mean_doses = mean(change_vaccinations, na.rm = TRUE)) %>% 
  mutate(mean_doses = round(mean_doses, 0))

plot_df2 %>% 
  ggplot(aes(x = week_day, y = mean_doses)) +
  geom_point() +
  geom_segment(aes(x=week_day, xend=week_day, y=0, yend=mean_doses)) +
  scale_y_continuous(breaks = plot_df2$mean_doses) +
  theme(panel.grid.minor = element_blank()) +
  labs(
    y = "Mean Doses administered",
    x = "Day of the Week",
    title = "Nova Scotia is not vaccinating on the weekends"
  )
```
