---
title: "NS Covid Rates"
author: "Gordon Shotwell"
output: html_document
params:
  data: covid
---

```{r setup, include=FALSE}
library(dplyr)
library(ggplot2)
library(RcppRoll)
library(readr)

raw_data  <-  readr::read_csv("https://novascotia.ca/coronavirus/data/ns-covid19-data.csv", skip = 1)

process_covid <- function(raw_data) {
  raw_data$Hospitalized <- NULL
  covid <- raw_data[, 1:8]
  names(covid) <- tolower(names(covid))
  names(covid)[1:2] <- c("date", "new_cases")
  names(covid)[names(covid) == "new_1"] <- "daily_tests"
  covid$positives <- cumsum(covid$new_cases)
  write.csv(covid, "ns_daily_covid.csv")
  return(covid)
}

covid <- process_covid(raw_data)

covid <- covid %>% 
  mutate(total_deaths = cumsum(deaths)) %>% 
  mutate(active = positives - resolved - total_deaths) %>% 
  mutate(wave = ifelse(date < "2020-10-21", "Wave 1", "Wave 2")) %>% 
  arrange(date) %>% 
  group_by(wave) %>% 
  mutate(date_num = as.numeric(date - min(date))) %>%
  janitor::clean_names()

active_cases <- covid$active[nrow(covid)]

```

There are **`r active_cases`** active cases in Nova Scotia as of **`r max(covid$date)`**.

The data comes from [daily reports](https://novascotia.ca/coronavirus/#cases) from the Nova Scotia Government which I record in a [Github Repo](https://github.com/GShotwell/ns_covid).

```{r plots, echo = FALSE, warning=FALSE, message=FALSE}
theme_set(theme_minimal())
```

# Cases

```{r, echo = FALSE, warning=FALSE, message=FALSE}

covid %>% 
  ggplot(aes(x = date_num, y = active, group = wave, colour = wave)) +
  geom_step() +
  labs(y = "Active Cases",
       x = "Days since outbreak began",
       title = "Nova Scotia Covid Waves",
       subtitle = "Wave 2 began on October 21") +
  theme_light()

case_df <- covid %>% 
  mutate(roll_cases = roll_mean(new_cases, 7, fill = NA, align = "center"))

ggplot(case_df, aes(x = date_num, y = roll_cases, group = wave, colour = wave)) +
  geom_line() +
  geom_point(aes(y = new_cases), alpha = 0.2) +
  labs(y = "New cases (7 day average)",
       x = "Days since outbreak began",
       title = "Nova Scotia Covid Waves",
       subtitle = "Wave 2 began on October 21") +
  theme_light() 

case_df %>% 
  group_by(wave) %>% 
  mutate(positives = positives - min(positives, na.rm = TRUE)) %>% 
  ggplot(aes(y = roll_cases, x = positives, colour = wave)) +
  geom_point() +
  labs(y = "New cases \n(7 day average)",
       x = "Total cases",
       title = "Infection peak plot",
       subtitle = "Wave 2 began on October 21")

case_df %>% 
  group_by(wave) %>% 
  mutate(positives = positives - min(positives, na.rm = TRUE)) %>% 
  ggplot(aes(y = roll_cases, x = positives, colour = wave)) +
  geom_point() +
  labs(y = "New cases \n(7 day average)",
       x = "Total cases",
       title = "Infection peak plot (Log scale)",
       subtitle = "Wave 2 began on October 21") +
  scale_x_log10() +
  scale_y_log10()
  



```


# Tests

```{r echo=FALSE, message=FALSE, warning=FALSE}

plot_df <- covid %>% 
  ungroup() %>% 
  arrange(date) %>% 
  mutate(positive_rate = new_cases / daily_tests,
         positive_rate_roll = roll_mean(positive_rate, 7, fill = NA, align = "center", na.rm = TRUE)) 

plot_df %>% 
  ggplot(aes(x = date_num, y = positive_rate_roll, group = wave, colour = wave)) +
  geom_line() +
  geom_point(aes(y = positive_rate), alpha = 0.3) +
  labs(y = "Positive rate (7 day average)",
       x = "Days since outbreak began",
       title = "Nova Scotia Covid Waves",
       subtitle = "Wave 2 began on October 21") +
  scale_y_continuous(labels = scales::percent) +
  theme_light()

```

# Hospitalizations

```{r echo=FALSE, warning=FALSE}
covid %>%
  mutate(hospital = icu + non_icu) %>% 
  ggplot(aes(x = date_num, y = hospital, group = wave, colour = wave)) +
  geom_step() +
  labs(y = "Hospitalized patients",
       x = "Days since outbreak began",
       title = "Nova Scotia Covid Waves",
       subtitle = "Wave 2 began on October 21") +
  theme_light()

```

