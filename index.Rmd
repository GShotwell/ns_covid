---
title: "NS Covid Rates"
author: "Gordon Shotwell"
output: html_document
params:
  data: covid
---

```{r setup, include=FALSE}
library(dplyr)
library(ggplot2)
library(RcppRoll)
library(lubridate)
library(readr)
library(httr)
library(tidyr)
resp <- GET("https://api.covid19tracker.ca/reports/province/ns")
covid <- tibble(raw = content(resp)$data) %>% 
  unnest_auto(raw)

covid <- covid %>% 
  mutate(active = total_cases - total_fatalities - total_recoveries,
         date = lubridate::ymd(date)) %>%
  filter(date > "2020-03-15") %>% 
  mutate(wave = ifelse(date < "2020-10-21", "Wave 1", "Wave 2")) %>% 
  arrange(date) %>% 
  group_by(wave) %>% 
  mutate(date_num = as.numeric(date - min(date))) %>% 
  mutate(active = ifelse(active < 0, 0, active)) 

active_cases <- covid$active[nrow(covid)]
```

There are **`r active_cases`** active cases in Nova Scotia as of **`r max(covid$date)`**.

The data comes from [the Covid Tracker API](https://api.covid19tracker.ca/).

```{r plots, echo = FALSE, warning=FALSE, message=FALSE}
theme_set(theme_minimal())
```

# Cases

```{r, echo = FALSE, warning=FALSE, message=FALSE}

covid %>% 
  ggplot(aes(x = date_num, y = active, group = wave, colour = wave)) +
  geom_step() +
  labs(y = "Active Cases",
       x = "Days since outbreak began",
       title = "Nova Scotia's second wave has been smaller than the first",
       subtitle = "Wave 2 began on October 21") +
  theme_light()

case_df <- covid %>% 
  arrange(date) %>% 
  mutate(roll_cases = roll_mean(change_cases, 7, fill = NA, align = "right")) %>%
  mutate(eight_day = roll_sum(change_cases, 8, fill = NA, align = "right")) 

ggplot(case_df, aes(x = date_num, y = roll_cases, group = wave, colour = wave)) +
  geom_line() +
  geom_point(aes(y = change_cases), alpha = 0.2) +
  labs(y = "New cases (7 day average)",
       x = "Days since outbreak began",
       title = "Nova Scotia's second wave has been smaller than the first",
       subtitle = "Wave 2 began on October 21") +
  theme_light() 
```

# Vaccines

```{r message=FALSE, warning=FALSE, echo=FALSE}
resp <- GET("https://api.covid19tracker.ca/reports/province/ns")
resp <- tibble(raw = content(resp)$data)

vaccines <- resp %>% 
  unnest_auto(raw) %>% 
  select(date, change_vaccinations, change_vaccines_distributed, total_vaccinations, total_vaccines_distributed)

vaccines <- vaccines %>% 
  filter(date > lubridate::ymd("2020-12-01")) %>% 
  mutate(date = lubridate::ymd(date),
         vaccinated = roll_sum(change_vaccinations, 7, fill = NA, align = "right") / 7,
         vaccine_distributed = roll_sum(change_vaccines_distributed, 7, fill = NA, align = "right") / 7) %>% 
  mutate(in_freezer = total_vaccines_distributed - total_vaccinations) %>% 
  arrange(date)

plot_df <- case_df %>% 
  ungroup() %>% 
  select(date, active) %>% 
  left_join(vaccines, by = "date") %>% 
  mutate(vaccine_ratio = total_vaccinations / active,
         vaccine_distributed_ratio = vaccinated / vaccine_distributed) %>% 
  filter(!is.na(vaccine_ratio))
```

There are `r scales::comma(vaccines$in_freezer[nrow(vaccines)])` vaccines sitting in Nova Scotian freezers.

```{r message=FALSE, warning=FALSE, echo=FALSE}
plot_df %>% 
  select(date,  `Available` = total_vaccines_distributed, `Distributed` = total_vaccinations) %>% 
  pivot_longer(-date) %>% 
  filter(date > "2020-12-21") %>% 
  ggplot(aes(x = date, y = value, group = name, fill = name)) +
  geom_ribbon(aes(ymax = value, ymin = 0)) +
  labs(
    title = "Nova Scotia's vaccine distribution has been slow",
    x = "Date",
    y = "Doses",
    fill = "Doses"
  ) +
  scale_fill_viridis_d() +
  scale_y_continuous(breaks = c(max(plot_df$total_vaccinations), 
                                max(plot_df$total_vaccines_distributed, na.rm = TRUE)),
                     labels = scales::comma)

vaccines %>% 
    filter(date > "2020-12-21") %>% 
  ggplot(aes(x = date, y = in_freezer)) +
  geom_path() +
  scale_y_continuous(breaks = c(5000, 10000, 15000, vaccines$in_freezer[nrow(vaccines)]),
                     labels = scales::comma) +
  labs(title = "Nova Scotia has a lot of unused vaccine",
       y = "Unused vaccine doses",
       x = "Date")

plot_df %>% 
    filter(date > "2020-12-21") %>% 
  ggplot(aes(x = date, y = vaccine_ratio)) +
  geom_line() +
  geom_path() +
  scale_y_continuous(labels = scales::comma) +
  labs(title = "There are many more vaccinations than cases",
       y = "Vaccinations per case",
       x = "Date")

```

